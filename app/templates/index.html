{% extends "base.html" %}

{% block title %}Object Detection Game{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YOLOv5 Quiz</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/styles.css') }}">

</head>
<body>
    <h1>YOLOv5 Quiz</h1>
    <div>
        <img id="video" src="" alt="Video Feed - press Start Video">
    </div>
    <div>
        <button onclick="startQuiz()">Start Quiz</button>
        <button onclick="startVideo()">Start Video</button>
        <button onclick="pauseVideo()">Pause Video</button>
    </div>
    <div id="quiz">
        <p id="question">Question will appear here</p>
        <button id="answer1" class="quiz-button" onclick="answerQuestion(this)" >Scissors</button>
        <button id="answer2" class="quiz-button" onclick="answerQuestion(this)" >Cup</button>
        <button id="answer3" class="quiz-button" onclick="answerQuestion(this)" >Book</button>
    </div>
    <div id="correct-answer" class="correct-answer"></div>
    <div id="score">Score: 0</div>
    <div id="time">Time left: 30 seconds</div>
    <div id="extra-paragraph"></div>

    <script>
        let score = 0;
        let timeLeft = 30;
        let correctAnswer = 0;
        let timer = null;
        let autoAnswerInterval = null;  // Variable to keep track of the interval ID

        function pauseVideo() {
            const videoElement = document.getElementById('video');
            videoElement.src = "";  // Stop the video feed
            
            // Clear the autoAnswer interval
            if (autoAnswerInterval !== null) {
                clearInterval(autoAnswerInterval);
                autoAnswerInterval = null;
            }
        }

        function startVideo() {
            const videoElement = document.getElementById('video');
            videoElement.src = "{{ url_for('main.video_feed') }}";  // Start the video feed

            // Start autoAnswer if the video is running
            if (videoElement.src !== "") {
                // Only start a new interval if one isn't already running
                if (autoAnswerInterval === null) {
                    autoAnswerInterval = setInterval(autoAnswer, 1000);
                }
            }
        }

        function startQuiz() {
            // Reset score and time
            score = 0;
            timeLeft = 30;
            document.getElementById('score').innerText = 'Score: ' + score;
            document.getElementById('time').innerText = 'Time left: ' + timeLeft + ' seconds';

            // Clear any existing timer
            if (timer) {
                clearInterval(timer);
            }

            // Fetch the first question
            fetch('/start_quiz')
                .then(response => response.json())
                .then(data => {
                    console.log('Quiz data received:', data);  // Debugging line
                    document.getElementById('question').innerText = data.question;
                    correctAnswer = data.correctAnswer;
                    // Shuffle answers and display
                    const answers = [data.correctAnswer, ...data.incorrectAnswers];
                    shuffleArray(answers);

                    document.getElementById('answer1').innerText = answers[0];
                    document.getElementById('answer2').innerText = answers[1];
                    document.getElementById('answer3').innerHTML = answers[2];

                    // Enable the buttons after setting the new question
                    const buttons = document.querySelectorAll('.quiz-button');
                    buttons.forEach(btn => btn.disabled = false);

                })
                .catch(error => {
                    console.error('Error fetching question:', error);
                });

            // Start the timer
            timer = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    alert('Game Over! Your score is ' + score);
                } else {
                    timeLeft -= 1;
                    document.getElementById('time').innerText = 'Time left: ' + timeLeft + ' seconds';
                }
            }, 1000);
        }

        function answerQuestion(button) {
            const selectedAnswer = button.innerText;
            console.log('Selected Answer:', selectedAnswer, 'Correct Answer:', correctAnswer);

            if (selectedAnswer === String(correctAnswer)) {  
                score += 1;
                document.getElementById('score').innerText = 'Score: ' + score;
                fetch('/next_question')
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('question').innerText = data.question;
                        correctAnswer = data.correctAnswer;

                        // Shuffle answers and display
                        const answers = [data.correctAnswer, ...data.incorrectAnswers];
                        shuffleArray(answers);

                        document.getElementById('answer1').innerText = answers[0];
                        document.getElementById('answer2').innerText = answers[1];
                        document.getElementById('answer3').innerText = answers[2];

                        // Re-enable the buttons after the question is updated
                        const buttons = document.querySelectorAll('.quiz-button');
                        buttons.forEach(btn => {
                            btn.disabled = false;
                        });
                    });
            } else {
                // add something
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];  // Swap elements
    }
}
        function autoAnswer() {
            fetch('/detection_data')
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        return;  // Do nothing if there is no data
                    }

                    // Find the item with the maximum confidence
                    let maxConfidenceItem = data.reduce((maxItem, item) => {
                        return item.confidence > maxItem.confidence ? item : maxItem;
                    }, { confidence: -1 });  // Initialize with a confidence lower than any possible value

                    // Auto-answer based on the item with the highest confidence
                    if (maxConfidenceItem.confidence > 0) {  // Ensure confidence is greater than zero
                        let buttonId;
                        if (maxConfidenceItem.label === "scissors") {
                            buttonId = 'answer1';
                        } else if (maxConfidenceItem.label === "cup") {
                            buttonId = 'answer2';
                        } else if (maxConfidenceItem.label === "book") {
                            buttonId = 'answer3';
                        }
                        console.log('Autoselected Button:', buttonId);

                        if (buttonId) {
                            const button = document.getElementById(buttonId);
                            if (button) {
                                button.click();
                            }
                        }
                    }
                    // Clear detections after processing
                    fetch('/clear_detections', { method: 'POST' })
                        .catch(error => {
                            console.error('Error clearing detections:', error);
                        });
                })
                .catch(error => {
                    console.error('Error fetching detection data:', error);
                });
        }

        function handleButtonClick(button) {
            // Check if the first button was clicked
            if (button.id === 'answer1') {
                addParagraph();
            }
            answerQuestion(2);
        }
        function addParagraph() {
            // Create a new paragraph element
            const newParagraph = document.createElement('p');

            // Set the text content of the paragraph
            newParagraph.textContent = "This is an additional paragraph added to the webpage.";

            // Append the paragraph to the div with id 'extra-paragraph'
            document.getElementById('extra-paragraph').appendChild(newParagraph);
        }
    </script>
    
</body>
</html>
{%endblock%}